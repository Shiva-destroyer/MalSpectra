# Module 3: Dynamic Sandbox

## Overview

The Dynamic Sandbox module provides a safe, monitored environment for executing suspicious files and observing their behavior. It tracks process creation, file system changes, and network activity in real-time, providing comprehensive behavior analysis without risking the host system.

## ⚠️ CRITICAL SAFETY WARNING ⚠️

**THIS MODULE EXECUTES POTENTIALLY MALICIOUS CODE!**

### Requirements:
- ✅ Run ONLY inside a Virtual Machine (VM)
- ✅ Ensure VM has NO network access to production systems
- ✅ Take VM snapshot before testing
- ✅ Use disposable VMs that can be reset

### Risks of Improper Use:
- ❌ System compromise
- ❌ Data loss
- ❌ Network infection
- ❌ Irreversible damage

**DO NOT RUN THIS ON YOUR HOST MACHINE!**

## Features

- **Process Monitoring**: Tracks new processes spawned by malware
- **File System Monitoring**: Detects file creation, modification, and deletion
- **Network Monitoring**: Captures network connections and remote endpoints
- **Timeout Protection**: Automatically terminates long-running processes
- **Behavior Reporting**: Comprehensive report of all suspicious activities
- **Safety Confirmation**: Requires explicit VM confirmation before execution

## Technical Details

### Components

1. **process_monitor.py**
   - Uses `psutil` to snapshot running processes
   - Compares baseline vs. current state
   - Identifies new and terminated processes
   - Captures: PID, name, command line, user, create time

2. **file_monitor.py**
   - Monitors directory for file system changes
   - Tracks file creation, modification, deletion
   - Uses snapshot comparison approach
   - Records: path, change type, timestamp, size

3. **network_monitor.py**
   - Monitors network connections via `psutil.net_connections()`
   - Tracks new connections established
   - Captures: local/remote address, ports, status, PID
   - Identifies process responsible for connection

4. **sandbox.py**
   - Main execution harness
   - Coordinates all monitors
   - Executes target with subprocess
   - Enforces timeout limits
   - Generates comprehensive report

5. **main.py**
   - User interface with safety warnings
   - VM confirmation workflow
   - Result display with Rich formatting

### Monitoring Techniques

#### Process Monitoring Algorithm

```
1. Baseline Snapshot
   - Iterate all running processes (psutil.process_iter)
   - Store PIDs in set
   ↓
2. Execute Malware
   - Run target file
   ↓
3. Current Snapshot
   - Iterate all running processes again
   ↓
4. Comparison
   - New processes = current_pids - baseline_pids
   - Terminated = baseline_pids - current_pids
```

#### File Monitoring Algorithm

```
1. Baseline Snapshot
   - Walk directory tree (os.walk)
   - Store file paths and mtimes
   ↓
2. Execute Malware
   - Run target file
   ↓
3. Current Snapshot
   - Walk directory tree again
   ↓
4. Comparison
   - Created = files in current but not baseline
   - Modified = files with newer mtime
   - Deleted = files in baseline but not current
```

#### Network Monitoring Algorithm

```
1. Baseline Snapshot
   - Get all connections (psutil.net_connections)
   - Store connection tuples (laddr, raddr, status, pid)
   ↓
2. Execute Malware
   - Run target file
   ↓
3. Current Snapshot
   - Get all connections again
   ↓
4. Comparison
   - New connections = current - baseline
   - Extract process name from PID
```

### Sandbox Report Structure

```python
@dataclass
class SandboxReport:
    target_file: str              # Path to executed file
    execution_time: float         # Time taken to execute
    exit_code: Optional[int]      # Process exit code
    timed_out: bool               # Whether execution timed out
    error_message: str            # Any error messages
    
    new_processes: List[ProcessInfo]      # New processes spawned
    terminated_processes: List[ProcessInfo]  # Processes that terminated
    file_changes: List[FileChange]        # File system changes
    network_connections: List[ConnectionInfo]  # Network activity
    
    start_time: str               # ISO format timestamp
    end_time: str                 # ISO format timestamp
```

## Usage

### Safety Workflow

1. **Module Selection**: Select Module 3 from main menu
2. **Safety Warning**: Read BRIGHT RED warning carefully
3. **VM Confirmation**: Type "YES" to confirm you're in a VM
4. **Target Selection**: Provide path to file to execute
5. **Timeout Configuration**: Set execution timeout (default: 10s)
6. **Execution Confirmation**: Press Enter to proceed
7. **Monitoring**: Sandbox runs with all monitors active
8. **Report Display**: View comprehensive behavior analysis

### Example Session

```
⚠️  CRITICAL SAFETY WARNING ⚠️

THIS MODULE EXECUTES POTENTIALLY MALICIOUS CODE!

DO NOT RUN THIS ON YOUR HOST MACHINE!

Are you running inside a Virtual Machine?
Type 'YES' to confirm: YES

✓ VM confirmation received

Enter path to file to execute in sandbox:
> data/test_malware_safe.py

Enter execution timeout (seconds):
(Default: 10 seconds)
> 10

Ready to execute:
  File: data/test_malware_safe.py
  Timeout: 10s

Press Enter to continue or Ctrl+C to abort...

Executing in sandbox...
Monitoring: processes, files, network

═══════════════════════════════════════════════════════════════
                  SANDBOX EXECUTION REPORT
═══════════════════════════════════════════════════════════════
```

### Execution Report

The report includes:

1. **Execution Summary**
   - Target file path
   - Execution time
   - Exit code
   - Timeout status
   - Error messages (if any)

2. **Process Activity**
   - New processes created
   - PID, name, username
   - Command line arguments
   - Creation time

3. **File System Changes**
   - Files created (GREEN)
   - Files modified (YELLOW)
   - Files deleted (RED)
   - File paths and sizes

4. **Network Connections**
   - Process responsible
   - Local address:port
   - Remote address:port
   - Connection status

### Example Output

```
╔════════════════════════════════════════════════════════════╗
║                  Execution Summary                         ║
╠════════════════════════════════════════════════════════════╣
║ Target File      │ data/test_malware_safe.py              ║
║ Execution Time   │ 5.23s                                  ║
║ Exit Code        │ 0                                      ║
║ Timed Out        │ No                                     ║
╚════════════════════════════════════════════════════════════╝

New Processes Created:
┏━━━━━━┳━━━━━━━━━━━━━━━┳━━━━━━━━━━━━┓
┃ PID  ┃ Name          ┃ User       ┃
┡━━━━━━╇━━━━━━━━━━━━━━━╇━━━━━━━━━━━━┩
│ 1234 │ python3       │ malware    │
│ 1235 │ persistence   │ malware    │
└──────┴───────────────┴────────────┘

File System Changes:
┏━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━┓
┃ Type     ┃ Path                 ┃ Size   ┃
┡━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━┩
│ CREATED  │ infected.txt         │ 256    │
│ CREATED  │ malware_payload.dat  │ 1024   │
│ MODIFIED │ system.config        │ 512    │
└──────────┴──────────────────────┴────────┘

Network Connections:
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━┓
┃ Process      ┃ Local          ┃ Remote           ┃ Status    ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━┩
│ python3(1234)│ 192.168.1.10:  │ 192.0.2.1:4444   │ ESTABLISHED│
│              │ 54321          │                  │           │
└──────────────┴────────────────┴──────────────────┴───────────┘
```

## Supported File Types

The sandbox automatically detects and handles:

1. **Python Scripts** (`.py`)
   - Executed with: `python3 script.py`

2. **Shell Scripts** (`.sh`, `.bash`)
   - Executed with: `bash script.sh`

3. **Binary Executables**
   - Executed directly: `./binary`

4. **Custom Handling**
   - Extend `sandbox.py` to add more file types

## Configuration

### Default Timeout

Default execution timeout is **10 seconds**. This can be:
- Changed per-execution (user prompt)
- Modified in code (see Customization)

### Watch Directory

Default watch directory is `./sandbox_watch`. This directory:
- Is created automatically
- Contains monitored file system
- Can be changed in code

### Customization

```python
# In sandbox.py

# Change default timeout
DEFAULT_TIMEOUT = 30  # 30 seconds

# Change watch directory
sandbox = Sandbox(watch_dir="/custom/watch/path")

# Change execution behavior
def execute(self, target_file: str, timeout: int = 30, args: list[str] = None):
    # Custom logic here
```

## Use Cases

### 1. Malware Behavior Analysis
Execute unknown malware samples to observe their behavior patterns.

### 2. Suspicious Script Testing
Test potentially malicious scripts in isolation.

### 3. Persistence Mechanism Detection
Identify how malware achieves persistence (process creation, file modification).

### 4. Network C&C Detection
Discover command-and-control server connections.

### 5. Data Exfiltration Analysis
Monitor file access and network activity for data theft patterns.

### 6. Ransomware Analysis
Observe file encryption patterns and ransom note creation.

## Limitations

### Technical Limitations
- Cannot detect kernel-level rootkits
- Limited virtualization awareness (some malware detects VMs)
- Network monitoring requires elevated privileges
- File monitoring limited to watched directory
- Process monitoring may miss very short-lived processes

### Safety Limitations
- Does NOT provide complete isolation
- VM escape exploits exist
- Network-based attacks can spread
- Requires proper VM configuration

### Performance Limitations
- Timeout enforcement is not instant
- File system scanning has overhead
- Process enumeration is snapshot-based

## Best Practices

### VM Setup
1. **Use Isolated Network**: No production network access
2. **Create Snapshots**: Before each analysis session
3. **Limit Resources**: Prevent VM from consuming host resources
4. **No Shared Folders**: Disable host-VM file sharing
5. **Monitor VM**: Watch for escape attempts

### Analysis Workflow
1. **Take Snapshot**: Before running sandbox
2. **Run Analysis**: Execute suspicious file
3. **Save Report**: Document findings
4. **Revert Snapshot**: Clean state for next analysis
5. **Analyze Results**: Look for IOCs and TTPs

### Timeout Selection
- **Quick Scripts**: 5-10 seconds
- **Installers**: 30-60 seconds
- **Droppers**: 10-30 seconds
- **Ransomware**: 60-120 seconds (observe encryption)

## Troubleshooting

### "Permission denied" errors
- Network monitoring requires root/admin privileges
- Run with: `sudo python3 main.py`

### "No processes detected"
- Process lifetime too short
- Increase monitoring window in code

### "No file changes detected"
- Malware writing outside watch directory
- Expand watch directory or use filesystem-wide monitoring

### "No network connections detected"
- Network activity too brief
- Increase post-execution sleep time
- Check if elevated privileges needed

### VM Detection
- Some malware detects VMs and alters behavior
- Use VM evasion techniques
- Try different VM platforms (VirtualBox, VMware, KVM)

## Advanced Features

### Custom Monitors

Add custom monitoring:

```python
class CustomMonitor:
    def start_monitoring(self):
        # Initialize monitoring
        pass
    
    def stop_monitoring(self):
        # Return collected data
        pass

# In sandbox.py
self.custom_monitor = CustomMonitor()
self.custom_monitor.start_monitoring()
# ... execute ...
custom_data = self.custom_monitor.stop_monitoring()
```

### Registry Monitoring (Windows)

For Windows malware analysis, add registry monitoring:

```python
import winreg

class RegistryMonitor:
    def monitor_keys(self):
        # Monitor HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run
        # Detect persistence mechanisms
        pass
```

### API Hooking

For deeper analysis, integrate API hooking:
- Use Frida for dynamic instrumentation
- Hook critical API calls (CreateFile, RegSetValue, socket, etc.)
- Log parameters and return values

## Testing with Safe Malware

Use the included test script:

```bash
# From MalSpectra root directory
python3 main.py
# Select Module 3
# Confirm VM (type YES)
# Enter: data/test_malware_safe.py
# Enter timeout: 10
# Observe behavior report
```

The test script simulates:
- ✅ File creation
- ✅ File modification
- ✅ File deletion
- ✅ Process activity (simulated)
- ✅ Network connections (simulated)

## Integration with Other Modules

### With Reverse Engineering Module
1. Run static analysis (Module 1) first
2. Identify suspicious functions
3. Run in sandbox (Module 3) to observe runtime behavior

### With Ghidra Bridge Module
1. Extract functions with Ghidra (Module 2)
2. Identify API calls and imports
3. Validate behavior in sandbox (Module 3)

## References

- **psutil Documentation**: https://psutil.readthedocs.io/
- **Sandbox Analysis Techniques**: https://www.sans.org/white-papers/33649/
- **Malware Analysis Best Practices**: https://www.cisa.gov/uscert/ncas/tips/ST04-014

---

**Developer**: Sai Srujan Murthy  
**Email**: saisrujanmurthy@gmail.com  
**Module**: Dynamic Sandbox  
**Version**: 1.0  
**Safety Level**: ⚠️ USE WITH EXTREME CAUTION ⚠️
